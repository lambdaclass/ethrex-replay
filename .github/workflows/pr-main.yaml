name: Replay
permissions:
  contents: read
on:
  # For now on every push so that i test it
  push:
    branches: ["**"]
  # pull_request:
  #   branches: ["**"]

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    name: Lint
    strategy:
      fail-fast: false
      matrix:
        features: ["", "l2", "l2,sp1", "l2,risc0", "sp1", "risc0"]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Rust Environment
        uses: ./.github/actions/setup-rust

      - name: Install rustfmt
        run: rustup component add rustfmt

      - name: Install clippy
        run: rustup component add clippy

      - name: RISC-V Risc0 toolchain install
        if: contains(matrix.features, 'risc0')
        # We need this in order to do cargo check
        run: |
          curl -L https://risczero.com/install | bash
          ~/.risc0/bin/rzup install rust

      - name: cargo fmt --check --all
        if: matrix.features == '' # Run only without features because it's redundant to run it on all jobs
        run: cargo fmt --check --all

      - name: cargo check
        shell: bash
        env:
          FEATURE_ARGS: ${{ matrix.features }}
        run: |
          set -euxo pipefail
          args=(--release --no-default-features)
          if [ -n "${FEATURE_ARGS}" ]; then
            args+=("--features" "${FEATURE_ARGS}")
          fi
          cargo check "${args[@]}"

      - name: cargo clippy
        shell: bash
        env:
          FEATURE_ARGS: ${{ matrix.features }}
        run: |
          set -euxo pipefail
          args=(--release --no-default-features)
          if [ -n "${FEATURE_ARGS}" ]; then
            args+=("--features" "${FEATURE_ARGS}")
          fi
          cargo clippy "${args[@]}" -- -D warnings

  # The purpose of this job is to add it as a required check in GitHub so that we don't have to add every individual job as a required check
  all-lints:
    name: Lint
    runs-on: ubuntu-latest
    needs:
      - lint
    # Run regardless of matrix outcome so this job can report overall status
    if: ${{ always() }}
    steps:
      - name: Aggregate lint results
        run: |
          if [ "${{ needs.lint.result }}" = "success" ]; then
            echo "All lint jobs succeeded."
            exit 0
          fi
          echo "Some lint jobs failed" >&2
          exit 1

  test:
    runs-on: ubuntu-latest
    name: Execute an L1 block with ${{ matrix.backend }} backend
    strategy:
      fail-fast: false
      matrix:
        backend: ["sp1", "risc0", "exec"]
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          large-packages: false

      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup Rust Environment
        uses: ./.github/actions/setup-rust

      - name: RISC-V Risc0 toolchain install
        if: matrix.backend == 'risc0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        # should be able to specify a version for `rzup install rust` (toolchain version)
        # but it throws a "error decoding response body" in that case
        run: |
          curl -L https://risczero.com/install | bash
          ~/.risc0/bin/rzup install cargo-risczero 3.0.3
          ~/.risc0/bin/rzup install risc0-groth16
          ~/.risc0/bin/rzup install rust
      - name: RISC-V SP1 toolchain install
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: matrix.backend == 'sp1'
        run: |
          curl -L https://sp1.succinct.xyz | bash
          ~/.sp1/bin/sp1up --version 5.0.8

      - name: Build Risc0
        if: matrix.backend == 'risc0'
        run: |
          cargo b -r --no-default-features --features "${{ matrix.backend }}"

      - name: Build SP1
        if: matrix.backend == 'sp1'
        run: |
          cargo b -r --features "${{ matrix.backend }}"

      - name: Build No backend
        if: matrix.backend == 'exec'
        run: |
          cargo b -r

      - name: Run
        env:
          # TODO: Use cached attribute instead of RPC URL.
          RPC_URL: "http://45.76.185.153:8545"
        run: |
          # Install cache file before running
          install -D caches/cache_hoodi_1265656.json replay_cache/cache_hoodi_1265656.json

          if [ "${{ matrix.backend }}" = "exec" ]; then
            make execute BLOCK_NUMBER=1265656 NETWORK=hoodi
          else
            make execute-${{ matrix.backend }}-ci BLOCK_NUMBER=1265656 NETWORK=hoodi
          fi

  all-tests:
    # Test is required check, don't change the name
    name: Test
    runs-on: ubuntu-latest
    needs:
      - test
    # Run regardless of matrix outcome so this job can report overall status
    if: ${{ always() }}
    steps:
      - name: Aggregate test results
        run: |
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "All test jobs succeeded."
            exit 0
          fi
          echo "Some test jobs failed" >&2
          exit 1
